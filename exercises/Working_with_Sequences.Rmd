---
title: "Raw Data Quality Control"
author: "Carson Stacy & Jeffrey Lewis"
date: "Fall 2023"
output: html_document
---

last updated: `r Sys.Date()`

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# here::i_am("exercises/Gene_Ontology.Rmd")
```

# Getting Things Setup

As usual, make sure we have the right packages for this exercise
```{r ready-packages, results="hide",message=FALSE}

list.of.packages <- c("tidyverse", "here", "knitr", "BiocManager")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages,repos = "http://cran.us.r-project.org")
lapply(list.of.packages, require, character.only = TRUE)

```



We also need the bioconductor package "shortread" for today's activity.

Next, we need to install packages specific to our gene ontology bioinformatic analysis. Many of these packages aren't available on the R CRAN package repository, instead they are hosted on BioConductor repository that is focused on packages used in biological research. Today, we need to install the package topGO with the code below.

```{r install-GOpackage, results="hide", message=FALSE, warning=FALSE}
# make sure we have the CRAN package installed for getting bioconductor packages
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

if (!requireNamespace("Rfastp", quietly = TRUE))
    BiocManager::install("Rfastp")


# BiocManager::install("ShortRead")


```

# Description

This activity is intended to familiarize you with raw bioinformatic data.

# Learning outcomes

At the end of this exercise, you should be able to:

-   
-   
-   



```{r load-libraries, results="hide", message=FALSE, warning=FALSE}
library(Rfastp)
```

Let's use the same file from last class, this time performing GO term enrichment


## read in files
```{r access-data}
# assign url to a variable
DE_data_url <- "https://raw.githubusercontent.com/clstacy/GenomicDataAnalysis_Fa23/main/data/DE_results_heatshock_annotated.tsv"

# download the data from the web
DE_results_heatshock_annotated <-
  read_delim(DE_data_url, 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE)
```

Read in the example paired-end reads from the Rfastp package
```{r}
pe_read1 <- system.file("extdata","reads1.fastq.gz",package="Rfastp")
pe_read2 <- system.file("extdata","reads2.fastq.gz",package="Rfastp")
```


## QC and adapters
```{r}
pe_json_report <- rfastp(read1 = pe_read1, read2 = pe_read2,
    outputFastq = here("first_test_rfastp_pe"))

clipr_json_report <- rfastp(read1 = pe_read1, 
                            read2 = pe_read2,
    outputFastq = here('second_test_rfastp_pe'),
    disableTrimPolyG = TRUE,
    cutLowQualFront = TRUE,
    cutFrontWindowSize = 29,
    cutFrontMeanQual = 20,
    cutLowQualTail = TRUE,
    cutTailWindowSize = 1,
    cutTailMeanQual = 5,
    minReadLength = 29,
    adapterSequenceRead1 = 'GTGTCAGTCACTTCCAGCGG'
)
```








## Get DE gene list

We need a list of differentially expressed genes to test for over or under enrichment of terms. Here we choose genes significantly upregulated with a log2 fold change greater than 1.

```{r get-UPgeneList_phenol}
# subset to just genes with significant fdr & log2FC>1
DE_results_heatshock_annotated %>%
  filter(Phenol.HS.logFC > 1 & Phenol.HS.FDR < 0.05) 

DE_genes_upregulated_phenol <- DE_results_heatshock_annotated %>%
  filter(Phenol.HS.logFC > 1 & Phenol.HS.FDR < 0.05) %>%
  pull(ID) # get just the gene names
```

```{r get-phenolUPresults}
GO_phenol_up_results <- enrichGO(
  gene = DE_genes_upregulated_phenol,
  OrgDb = "org.Sc.sgd.db",
  universe = DE_results_heatshock_annotated$ID,
  keyType = "ORF",
  ont= "BP"
) %>%
  mutate(richFactor = Count / as.numeric(sub("/\\d+", "", BgRatio)))
```

```{r view-phenolUPdata, eval=FALSE}
# open up the results in a data frame to examine
GO_phenol_up_results %>%
  as_tibble() %>%
  View()
```

Now we can visualize the enrichment results, which shows us gene ontology categories that are enriched in upregulated genes in the phenol samples of the heat shock experiment.

```{r visualize-GOterms_upregulated_phenol}
# a simple visualization
plot(barplot(GO_phenol_up_results, showCategory = 10))

# a more complicated visualization, with more information density
ggplot(GO_phenol_up_results,
       showCategory = 15,
       aes(richFactor, fct_reorder(Description, richFactor))) +
  geom_segment(aes(xend = 0, yend = Description)) +
  geom_point(aes(color = p.adjust, size = Count)) +
  scale_color_gradientn(
    colours = c("#f7ca64", "#46bac2", "#7e62a3"),
    trans = "log10",
    guide = guide_colorbar(reverse = TRUE, order = 1)
  ) +
  scale_size_continuous(range = c(2, 10)) +
  xlab("Rich Factor") +
  ylab(NULL) +
  ggtitle("Biological Processes") +
  theme_bw()
```

You can try adjusting the size of the output figures by clicking the gear icon in the top right of the code chunk and click "use custom figure size". Note this updates the chunk header so the change is saved.

# The Hypergeometric Distribution in practice

Notice that trehalose metabolic process does not have very many genes in the category, but they appear to be highly present in the the upregulated gene list. Specifically, `r GO_phenol_up_results %>% as_tibble %>% filter(ID == "GO:0005991") %>% pull(GeneRatio) %>% cat()` DE genes have this GO term, where in the entire genome, there are only `r GO_phenol_up_results %>% as_tibble %>% filter(ID == "GO:0005991") %>% mutate(tmp = as.numeric(sub("/\\d+", "", BgRatio))) %>% pull(tmp) %>% cat()` genes. What are the odds that we see this by random chance? let's do the math:

```{r prepare-phyper}
# number of genes that have GO:0005991 (trehalose metabolic process)
trehalose_genes = 12
# number of genes that are DE (here phenol group heat shock, logFC>1)
DE_genes = 710
# number of genes that are both DE and trehalose genes
Overlap = 10
# total number of genes in experiment
total = 5650 # number of genes in genome
```

Without doing the math, do you expect these to be underrepresented, overrepresented, or neither?


### I need to give variable names for the below commands before I move on!

```{r test-phyper}
# test for underrepresentation (depletion)
phyper(q = Overlap, # number of trehalose genes that were DE
       m = DE_genes, # number of DE genes
       n = total-DE_genes, # number of non DE genes
       k = trehalose_genes, # number of observed DE trehalose genes
       lower.tail = TRUE) # the probability that X <= x

# test for overrepresentation (enrichmen t)
phyper(q = Overlap-1, # number of trehalose genes that were DE
                      # we subtract 1 b/c of lower.tail=FALSE means greater than
                      # without equality, so have to do one less
       m = DE_genes, # number of DE genes
       n = total-DE_genes, # number of non DE genes
       k = trehalose_genes, # number of observed DE trehalose genes
       lower.tail = FALSE) # the probability that X > x
```

As we see, there is strong evidence that the number of genes with this GO term is unlikely to be seen due to chance. In laymen's terms, this GO term is enriched in upregulated genes in response to heat shock. The test for underrepresenation shows there is no support for a hypothesis that this gene is underrepresented in the DE gene list.

Interestingly, the hypergeometric distribution is the same thing as the Fisher's Exact test, so we can rerun the same tests above with a different command:
```{r test-exactFisher}
#fisher test for underrepresentation
fisher.test(matrix(c(Overlap, DE_genes-Overlap, trehalose_genes-Overlap, total-DE_genes-trehalose_genes + Overlap), 2, 2), alternative='less')$p.value

#fisher test for overrepresentation
fisher.test(matrix(c(Overlap, DE_genes-Overlap, trehalose_genes-Overlap, total-DE_genes-trehalose_genes + Overlap), 2, 2), alternative='greater')$p.value
```

How does the p-value that we get from this test compare to the results table? They should match.


# Now it is your turn 

Try doing the same, except now create a different gene list. Some options could be:

- Downregulated in phenol+Heatshock instead of upregulated
- genes that are upregulated in either RNeasy or direct.zol heatshock columns.
- look at a different GO category (we only looked at BP, not MF or CC)

The code below is a template for you to modify to complete this activity.
The example code below looks at the RNeasy heatshock upregulated genes (choose something else for your gene list)
```{r get-[direction]geneList_[treatment]}
# subset to just genes meeting your requirements
DE_genes_GIVE_NAME <- DE_results_heatshock_annotated %>%
  filter(RNeasy.HS.logFC > 1 & RNeasy.HS.FDR<0.05) %>% # change for the filters that you want (see example above)
  pull(ID) # grabbing just the gene names
```

### Run Enrichment
```{r get-[treatment][direction]results}
GO_GIVE_NAME_results <- enrichGO(
  gene = DE_genes_GIVE_NAME,
  OrgDb = "org.Sc.sgd.db",
  universe = DE_results_heatshock_annotated$ID,
  keyType = "ORF",
  ont= "BP"
) %>%
  mutate(richFactor = Count / as.numeric(sub("/\\d+", "", BgRatio)))
```

### see the data
```{r view-[treatment][direction]data, eval=FALSE}
# open up the results in a data frame to examine
GO_GIVE_NAME_results %>%
  as_tibble() %>%
  View()
```

### create plots
```{r visualize-GOterms_[direction]_[treatment]}
# a simple visualization
plot(barplot(GO_GIVE_NAME_results, showCategory = 10))

# built in visualization with dots instead
dotplot(GO_GIVE_NAME_results, showCategory=10) 

# a more complicated visualization, with more information density
ggplot(GO_GIVE_NAME_results,
       showCategory = 15,
       aes(richFactor, fct_reorder(Description, richFactor))) +
  geom_segment(aes(xend = 0, yend = Description)) +
  geom_point(aes(color = p.adjust, size = Count)) +
  scale_color_gradientn(
    colours = c("#f7ca64", "#46bac2", "#7e62a3"),
    trans = "log10",
    guide = guide_colorbar(reverse = TRUE, order = 1)
  ) +
  scale_size_continuous(range = c(2, 10)) +
  xlab("Rich Factor") +
  ylab(NULL) +
  ggtitle("Biological Processes") +
  theme_bw()
```



Answer the following questions:

1.  Which GO term had the smallest adjusted p-value in the Phenol.HS upregulated example that we did together?

2.  What percent of the genes would we expect to have that GO term in the DE list under the null hypothesis? What percent of the DE genes actually had that GO term?

3.  Briefly explain your rationale for the cutoffs you chose for your gene list.

4.  Which GO term had the smallest adjusted p-value in the genelist that you chose yourself?

5.  In simple terms, how would you describe what the "Rich Factor" tells about a given GO term in the gene list.

6. Challenge: Create a venn diagram of the GO terms in the GO analysis you ran with the GO_phenol_up_results output

```{r create-vennDiagram}
# if (!requireNamespace("ggVennDiagram", quietly = TRUE))
#   install.packages("ggVennDiagram")
library(ggVennDiagram)

GO_results_list <- list(data.frame(GO_phenol_up_results)$ID,
                        data.frame(GO_GIVE_NAME_results)$ID)

ggVennDiagram(GO_results_list,
              category.names = c("Phenol_upregulated", "[GIVE_NAME]")) +
  scale_x_continuous(expand = expansion(mult = .2)) +
  scale_fill_distiller(palette = "RdBu"
  )
```



Be sure to knit this file into a pdf or html file once you're finished.

```{r}
sessionInfo()
```

